<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003" ToolsVersion="12.0">
	<PropertyGroup>
		<Version>$(Version)</Version>
		<FileVersion>$(BUILD_NUMBER)</FileVersion>
		<VersionLabel>$(BUILD_NUMBER)</VersionLabel>
		<ReleaseDate>2024-12-17</ReleaseDate>
		<BuildConfiguration></BuildConfiguration>
		<RootFolder>..</RootFolder>
		<TrunkFolder>$(RootFolder)\FuseCP</TrunkFolder>
		<Platform>Any CPU</Platform>

		<SetupTrunkFolder>$(RootFolder)\FuseCP.Installer</SetupTrunkFolder>
		<SetupBuildFolder>$(SetupTrunkFolder)\Build\$(BuildConfiguration)</SetupBuildFolder>
		<MSBuildCommunityTasksPath>$(RootFolder)\MSBuildCommunityTasks</MSBuildCommunityTasksPath>

		<BuildFolder>$(TrunkFolder)\Build\$(BuildConfiguration)</BuildFolder>
		<DeployFolder>$(TrunkFolder)\Deploy\$(BuildConfiguration)</DeployFolder>

		<PreviousBuildFolder>$(RootFolder)\..\prev\$(BuildConfiguration)</PreviousBuildFolder>

		<DiffCmd>$(TrunkFolder)\Tools\Diff.exe</DiffCmd>
		<!-- Lets keep all tools we need for the build together in a well-known place to avoid BUILD HELL -->
		<SqlCmd Condition="Exists('$(RootFolder)\tools\sqlcmd\sqlcmd.exe')">"$(RootFolder)\tools\sqlcmd\sqlcmd.exe" -S (local) -E</SqlCmd>
		<MSDeployPath Condition="Exists('$(RootFolder)\tools\webdeploy\msdeploy.exe')">"$(RootFolder)\tools\webdeploy\msdeploy.exe"</MSDeployPath>
		<ZipCmd>"$(RootFolder)\tools\7-Zip\7z.exe"</ZipCmd>
		
		<DataBaseName>FuseCP_build</DataBaseName>
		<MSDeployConnectionString>server=(local);Initial Catalog=$(DataBaseName);Integrated Security=true;</MSDeployConnectionString>

		<PortalSrc>$(TrunkFolder)\Sources\FuseCP.WebPortal</PortalSrc>
		<WebDavPortalSrc>$(TrunkFolder)\Sources\FuseCP.WebDavPortal</WebDavPortalSrc>
		<ServerSrc>$(TrunkFolder)\Sources\FuseCP.Server</ServerSrc>
		<EnterpriseServerSrc>$(TrunkFolder)\Sources\FuseCP.EnterpriseServer</EnterpriseServerSrc>
		<EnterpriseServerDataSrc>$(TrunkFolder)\Sources\FuseCP.EnterpriseServer.Data</EnterpriseServerDataSrc>
		<SchedulerServiceSrc>$(TrunkFolder)\Sources\FuseCP.SchedulerService\bin</SchedulerServiceSrc>
		<ImportCsvSrc>$(TrunkFolder)\Sources\Tools\FuseCP.Import.CsvBulk\bin\$(BuildConfiguration)</ImportCsvSrc>
		<HyperVUtilsSrc>$(RootFolder)\FuseCP.HyperV.Utils\Sources\FuseCP.HyperV.Utils\bin\$(BuildConfiguration)</HyperVUtilsSrc>
		<VMConfigSrc>$(RootFolder)\FuseCP.VmConfig\Sources\FuseCP.VmConfig\bin\$(BuildConfiguration)</VMConfigSrc>
		<ImportEnterpriseSrc>$(TrunkFolder)\Sources\Tools\FuseCP.Import.Enterprise\bin\$(BuildConfiguration)</ImportEnterpriseSrc>
		<CertMakerSrc>$(TrunkFolder)\Sources\Tools\SSL-Certificate-Maker\SSLCertificateMaker\bin\$(BuildConfiguration)</CertMakerSrc>
		<AWStatsViewerSrc>$(TrunkFolder)\Sources\Tools\FuseCP.AWStats.Viewer</AWStatsViewerSrc>
		<FCPTransportAgentSrc>$(TrunkFolder)\Sources\Tools\FCPTransportAgent</FCPTransportAgentSrc>
		<FuseCP-Configuration-ToolSrc>$(TrunkFolder)\Sources\Tools\FuseCP-Configuration-Tool</FuseCP-Configuration-ToolSrc>
		<MSPtoFCPSrc>$(TrunkFolder)\Sources\Tools\MSPtoFCP</MSPtoFCPSrc>
		<MailTemplatesSrc>$(TrunkFolder)\Sources\Tools\MailTemplates</MailTemplatesSrc>
		<FuseCP-Auto-Upgrade-ToolSrc>$(TrunkFolder)\Sources\Tools\FuseCP-Auto-Upgrade-Tool</FuseCP-Auto-Upgrade-ToolSrc>
		<FuseCP-dSHeuristicsSrc>$(TrunkFolder)\Sources\Tools\FuseCP-dSHeuristics</FuseCP-dSHeuristicsSrc>
		<FixDefaultPublicFolderMailboxSrc>$(TrunkFolder)\Sources\Tools\FuseCP.FixDefaultPublicFolderMailbox\bin\$(BuildConfiguration)</FixDefaultPublicFolderMailboxSrc>
		<ProgramFiles64>$(ProgramFiles.Replace(" (x86)", ""))</ProgramFiles64>
		<DevEnv>$(ProgramFiles64)\Microsoft Visual Studio\18\Community\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\18\Professional\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\18\Enterprise\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\2022\Community\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\2022\Professional\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\2022\Enterprise\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Community\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Professional\Common7\IDE\devenv.com</DevEnv>
		<DevEnv Condition="!Exists('$(DevEnv)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Enterprise\Common7\IDE\devenv.com</DevEnv>
		<MsBuildExe>$(ProgramFiles64)\Microsoft Visual Studio\18\Community\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\18\Enterprise\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\18\Professional\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2022\Community\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2022\Professional\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2022\Enterprise\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Community\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Professional\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(ProgramFiles64)\Microsoft Visual Studio\2019\Enterprise\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(MSBuildProgramFiles32)\Microsoft Visual Studio\18\BuildTools\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(MSBuildProgramFiles32)\Microsoft Visual Studio\2022\BuildTools\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>
		<MsBuildExe Condition="!Exists('$(MsBuildExe)')">$(MSBuildProgramFiles32)\Microsoft Visual Studio\2019\BuildTools\MSBuild\Current\Bin\MsBuild.exe</MsBuildExe>

		<ServerBuild>$(BuildFolder)\Server</ServerBuild>
		<EnterpriseServerBuild>$(BuildFolder)\EnterpriseServer</EnterpriseServerBuild>
		<SchedulerServiceBuild>$(BuildFolder)\SchedulerService</SchedulerServiceBuild>
		<PortalBuild>$(BuildFolder)\Portal</PortalBuild>
		<WebDavPortalBuild>$(BuildFolder)\WebDavPortal</WebDavPortalBuild>
		<ImportCsvBuild>$(BuildFolder)\Import.CsvBulk</ImportCsvBuild>
		<HyperVUtilsBuild>$(BuildFolder)\HyperVUtils</HyperVUtilsBuild>
		<VMConfigBuild>$(BuildFolder)\VMConfig</VMConfigBuild>
		<ImportEnterpriseBuild>$(BuildFolder)\Import.Enterprise</ImportEnterpriseBuild>
		<CertMakerBuild>$(BuildFolder)\CertificateMaker</CertMakerBuild>
		<AWStatsViewerBuild>$(BuildFolder)\AWStats.Viewer</AWStatsViewerBuild>
		<FCPTransportAgentBuild>$(BuildFolder)\FCPTransportAgent</FCPTransportAgentBuild>
		<LocalizationToolkitBuild>$(BuildFolder)\LocalizationToolkit</LocalizationToolkitBuild>
		<InstallerBuild>$(BuildFolder)\Installer</InstallerBuild>
		<FixDefaultPublicFolderMailboxBuild>$(BuildFolder)\FixDefaultPublicFolderMailbox</FixDefaultPublicFolderMailboxBuild>
        <WiXInstallerBuild>$(BuildFolder)\WiXInstaller</WiXInstallerBuild>
		<WIX Condition=" '$(WIX)' == '' ">$(RootFolder)\tools\WIX\x86</WIX>

		<!-- Include pdb's since users can send back StackTraces to ISP's, and with the pdb's the StackTraces contain
				line numbers and the ISP's can debug FuseCP. -->
		<IncludeReleasePdbs Condition="'$(IncludeReleasePdbs)' == ''">true</IncludeReleasePdbs>

		<!-- Use aspnet_compiler to precompile WebPortal if set to true (This also checks all ascx and aspx files for errors) -->
		<UseAspNetPrecompile Condition="'$(UseAspNetPrecompile)' == ''">false</UseAspNetPrecompile>

		<!-- Build Linux install deb & rpm packages (This requires a WSL distro with rpmbuild installed) -->
		<BuildLinuxInstallPackages Condition="'$(BuildLinuxInstallPackages)' == ''">true</BuildLinuxInstallPackages>

		<!-- Build legacy database sql script from install_db.sql & update_db.sql -->
		<BuildLegacyDatabaseScript Condition="'$(BuildLegacyDatabaseScript)' == ''">false</BuildLegacyDatabaseScript>

		<HighCompression Condition="'$(HighCompression)' == ''">true</HighCompression>

        <ZipExt Condition="$(HighCompression) == 'true'">.7z</ZipExt>
        <ZipExt Condition="$(HighCompression) != 'true'">.7z</ZipExt>

        <ZipLevel Condition="$(HighCompression) == 'true'"> -mx9 -mmt=on</ZipLevel>
        <ZipLevel Condition="$(HighCompression) != 'true'"> -mx3 -mmt=on</ZipLevel>
	</PropertyGroup>

	<PropertyGroup Label="WebPlatformFeed">
		<!-- URI where to locate the installer's distributive online -->
		<InstallerRemoteUri>http://installer.fusecp.com/files/$(Version)/FuseCP-$(Version)-webpi.msi</InstallerRemoteUri>
	</PropertyGroup>

	<Target Name="ShowParameters">
		<Message Text="Version: $(Version)" Importance="High" />
		<Message Text="FileVersion: $(FileVersion)" Importance="High" />
		<Message Text="VersionLabel: $(VersionLabel)" Importance="High" />
		<Message Text="IncludeReleasePdbs: $(IncludeReleasePdbs)" Importance="High" />
		<Message Text="UseAspNetPrecompile: $(UseAspNetPrecompile)" Importance="High" />
		<Message Text="BuildLinuxInstallPackages: $(BuildLinuxInstallPackages)" Importance="High" />
		<Message Text="BuildLegacyDatabaseScript: $(BuildLegacyDatabaseScript)" Importance="High" />
		<Message Text="HighCompression: $(HighCompression)" Importance="High" />
		<Message Text="MsBuildSwitches: $(MsBuildSwitches)" Importance="High" />
		<Message Text="UseDebugWebService: $(UseDebugWebService)" Importance="High" Condition="$(UseDebugWebService) != ''" />
		<Message Text="UseDebugWebService: true" Importance="High" Condition="$(UseDebugWebService) == ''" />
	</Target>

	<Target Name="RestorePackages" DependsOnTargets="ShowParameters">
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\FuseCP.Server.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\FuseCP.WebPortalAndEnterpriseServer.sln" />
		<Exec Command="dotnet restore /p:BuildWithNetFrameworkHostedCompiler=true $(TrunkFolder)\Sources\FuseCP.WebDavPortal.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\Tools\FuseCP.Import.CsvBulk.sln" />
		<Exec Command="dotnet restore $(RootFolder)\FuseCP.HyperV.Utils\Sources\FuseCP.HyperV.Utils.sln" />
		<Exec Command="dotnet restore $(RootFolder)\FuseCP.VmConfig\Sources\FuseCP.VmConfig.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\Tools\FuseCP.Import.Enterprise.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\Tools\FuseCP.AWStats.Viewer.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\Tools\SSL-Certificate-Maker\SSLCertificateMaker.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\Tools\FCPTransportAgent.sln" />
		<Exec Command="dotnet restore $(TrunkFolder)\Sources\Tools\FuseCP.FixDefaultPublicFolderMailbox.sln" />
	</Target>

	<Target Name="GenerateBuildVersionFilesInstaller" DependsOnTargets="RestorePackages">
		<AssemblyInfo CodeLanguage="CS" OutputFile="$(RootFolder)\FuseCP.Installer\Sources\VersionInfo.cs" AssemblyCompany="FuseCP" AssemblyCopyright="Copyright © 2026 FuseCP." AssemblyVersion="$(VersionLabel)" AssemblyFileVersion="$(FileVersion)" AssemblyInformationalVersion="$(Version)" />
	</Target>

	<Target Name="GenerateBuildVersionFiles" DependsOnTargets="GenerateBuildVersionFilesInstaller">
		<AssemblyInfo CodeLanguage="CS" OutputFile="$(TrunkFolder)\Sources\VersionInfo.cs" AssemblyCompany="FuseCP" AssemblyCopyright="Copyright © 2026 FuseCP." AssemblyVersion="$(VersionLabel)" AssemblyFileVersion="$(FileVersion)" AssemblyInformationalVersion="$(Version)" />
		<AssemblyInfo CodeLanguage="VB" OutputFile="$(TrunkFolder)\Sources\VersionInfo.vb" AssemblyCompany="FuseCP" AssemblyCopyright="Copyright © 2026 FuseCP." AssemblyVersion="$(VersionLabel)" AssemblyFileVersion="$(FileVersion)" AssemblyInformationalVersion="$(Version)" />
	</Target>

	<Target Name="BackupModelSnapshots" DependsOnTargets="GenerateBuildVersionFiles">
		<ItemGroup>
			<ModelSnapshots Include="$(EnterpriseServerDataSrc)\Migrations\**\*DbContextModelSnapshot.cs" />
		</ItemGroup>

		<PropertyGroup>
			<VersionTag>$(VersionLabel.Replace(".", "_"))</VersionTag>
			<ReplacementText>public class $2DbContext_$(VersionTag): $2DbContext {
#if NetCore
        public $2DbContext_$(VersionTag)(string connectionString, bool initSeedData = false): base(connectionString, initSeedData) { }
	    public $2DbContext_$(VersionTag)(DbContext context): base(context) { }
	    public $2DbContext_$(VersionTag)(DbContextOptions&lt;Context.DbContextBase&gt; options): base(options) { }
#else
	    public $2DbContext_$(VersionTag)(DbContext context): base(context) { }        
#endif
	}$1$1[DbContext(typeof($2DbContext_$(VersionTag)))]$1partial class $2DbContextModelSnapshot_$(VersionTag) : ModelSnapshot
			</ReplacementText>
		</PropertyGroup>

		<!-- Create a backup of the EntityFramework Model Snapshots -->
		<Copy SourceFiles="@(ModelSnapshots)"
			DestinationFiles="@(ModelSnapshots -> '$(EnterpriseServerDataSrc)\Migrations\%(RecursiveDir)%(Filename)_$(VersionTag)%(Extension)')" />

		<FileUpdate Files="@(ModelSnapshots -> '$(EnterpriseServerDataSrc)\Migrations\%(RecursiveDir)%(Filename)_$(VersionTag)%(Extension)')"
			Regex="\[DbContext\(typeof\([a-zA-Z0-9_]+DbContext\)\)]([ \t\r\n]*)partial class ([a-zA-Z0-9_]*)DbContextModelSnapshot\s*:\s*ModelSnapshot"
			ReplacementText="$(ReplacementText)" />
	</Target>

	<Target Name="CompileSources" DependsOnTargets="GenerateBuildVersionFiles">
		<!-- FuseCP -->
		<MSBuild Projects="$(TrunkFolder)\Sources\FuseCP.Server.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(TrunkFolder)\Sources\FuseCP.WebPortalAndEnterpriseServer.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<!--<MSBuild Projects="$(TrunkFolder)\Sources\FuseCP.WebDavPortal.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />-->

		<!-- Tools -->
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FuseCP.Import.CsvBulk.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(RootFolder)\FuseCP.HyperV.Utils\Sources\FuseCP.HyperV.Utils.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(RootFolder)\FuseCP.VmConfig\Sources\FuseCP.VmConfig.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FuseCP.Import.Enterprise.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FuseCP.AWStats.Viewer.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\SSL-Certificate-Maker\SSLCertificateMaker.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FCPTransportAgent.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
  		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FuseCP.FixDefaultPublicFolderMailbox.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" />
 	</Target>

	<Target Name="CompileWebDavPortal" DependsOnTargets="CompileSources">
		<Exec Command="&quot;$(MsBuildExe)&quot; &quot;$(TrunkFolder)\Sources\FuseCP.WebDavPortal.sln&quot; &quot;/p:Configuration=$(BuildConfiguration);Platform=$(Platform)&quot; $(MsBuildSwitches)" />
	</Target>

	<Target Name="PrepareBuilds" DependsOnTargets="CompileWebDavPortal">
		<!-- Remove build output folders in reversed order (e.q. root folder removed last) -->
		<RemoveDir Directories="$(ServerBuild)"/>
		<RemoveDir Directories="$(EnterpriseServerBuild)"/>
		<RemoveDir Directories="$(SchedulerServiceBuild)"/>
		<RemoveDir Directories="$(PortalBuild)"/>
		<RemoveDir Directories="$(WebDavPortalBuild)"/>
		<RemoveDir Directories="$(ImportCsvBuild)"/>
		<RemoveDir Directories="$(ImportEnterpriseBuild)"/>
		<RemoveDir Directories="$(CertMakerBuild)"/>
		<RemoveDir Directories="$(VMConfigBuild)"/>
		<RemoveDir Directories="$(HyperVUtilsBuild)"/>
		<RemoveDir Directories="$(AWStatsViewerBuild)"/>
		<RemoveDir Directories="$(FCPTransportAgentBuild)"/>
		<RemoveDir Directories="$(LocalizationToolkitBuild)"/>
		<RemoveDir Directories="$(InstallerBuild)"/>
	    <RemoveDir Directories="$(FixDefaultPublicFolderMailboxBuild)"/>
		<RemoveDir Directories="$(BuildFolder)"/>

    	<MakeDir Directories="$(BuildFolder)"/>
		<MakeDir Directories="$(ServerBuild)"/>
		<MakeDir Directories="$(EnterpriseServerBuild)"/>
		<MakeDir Directories="$(SchedulerServiceBuild)"/>
		<MakeDir Directories="$(PortalBuild)"/>
		<MakeDir Directories="$(WebDavPortalBuild)"/>
		<MakeDir Directories="$(HyperVUtilsBuild)"/>
		<MakeDir Directories="$(VmConfigBuild)"/>
		<MakeDir Directories="$(ImportCsvBuild)"/>
		<MakeDir Directories="$(ImportEnterpriseBuild)"/>
		<MakeDir Directories="$(CertMakerBuild)"/>
		<MakeDir Directories="$(AWStatsViewerBuild)"/>
		<MakeDir Directories="$(FCPTransportAgentBuild)"/>
		<MakeDir Directories="$(LocalizationToolkitBuild)"/>
		<MakeDir Directories="$(InstallerBuild)"/>
    	<MakeDir Directories="$(FixDefaultPublicFolderMailboxBuild)"/>
  	</Target>

	<Target Name="CreateServerBuild" DependsOnTargets="PrepareBuilds">
		<ItemGroup>
			<ServerBuildExclude Include="$(ServerSrc)\**\ref\**" />
			<ServerBuildExclude Include="$(ServerSrc)\bin\*.xml" />
			<ServerBuildExclude Include="$(ServerSrc)\bin\*.config" />
			<ServerBuildExclude Include="$(ServerSrc)\obj\**" />
			<ServerBuildExclude Include="$(ServerSrc)\**\Release\**" />
			<ServerBuildExclude Include="$(ServerSrc)\**\Debug\**" />
			<ServerBuildExclude Include="$(ServerSrc)\App_Cache\**" />
			<ServerBuildExclude Include="$(ServerSrc)\Images\**" />
			<ServerBuildExclude Include="$(ServerSrc)\LogParser\**" />
			<ServerBuildExclude Include="$(ServerSrc)\WebServices\**" />
			<ServerBuildExclude Include="$(ServerSrc)\Properties\**" />
			<!--<ServerBuildExclude Include="$(ServerSrc)\wwwroot\**" />-->
			<ServerBuildExclude Include="$(ServerSrc)\bin_dotnet\WebServices\**" />
			<ServerBuildExclude Include="$(ServerSrc)\bin\wwwroot\**" />
			<ServerBuildExclude Include="$(ServerSrc)\Pages\**" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs)" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.user" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.suo" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.cs" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.md" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.snk" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.log" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.old" />	
			<ServerBuildExclude Include="$(ServerSrc)\appsettings.json" />					
			<ServerBuildExclude Include="$(ServerSrc)\packages.config" />					
			<ServerBuildExclude Include="$(ServerSrc)\**\WsePolicyCache.Config" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.csproj" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.vb" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.vbproj" />
			<ServerBuildExclude Include="$(ServerSrc)\**\*.asmx" />
			<ServerBuildExclude Include="$(ServerSrc)\bin\Microsoft.Web.Administration.*"/>
			<ServerBuildExclude Include="$(ServerSrc)\bin\Microsoft.Web.Management.*"/>
			<ServerBuildExclude Include="$(ServerSrc)\bin\Microsoft.Exchange.*"/>
			<ServerBuildExclude Include="$(ServerSrc)\bin\Microsoft.Crm.*"/>
			<ServerBuildExclude Include="$(ServerSrc)\bin\Microsoft.SqlServer.BatchParser.dll"/>
			<ServerBuildFiles Include="$(ServerSrc)\**\*.*" Exclude="@(ServerBuildExclude)"/>
		</ItemGroup>
		<Copy SourceFiles="@(ServerBuildFiles)" DestinationFolder="$(ServerBuild)\%(RecursiveDir)" />
	</Target>
	<Target Name="CreateEnterpriseServerBuild" DependsOnTargets="CreateServerBuild">
		<ItemGroup>
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\ref\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\.svn\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\obj\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\bin\*.xml" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\bin\*.config" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\Release\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\Debug\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\Images\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.user" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.suo" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.cs" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.snk" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\appsettings.json" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\WsePolicyCache.Config" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.asmx" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.md" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.old" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.log" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\Properties\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\bin\refs\**" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.csproj" />
			<EnterpriseServerBuildExclude Include="$(EnterpriseServerSrc)\**\*.metacsproj" />
			<EnterpriseServerBuildFiles Include="$(EnterpriseServerSrc)\**\*.*" Exclude="@(EnterpriseServerBuildExclude)"/>
		</ItemGroup>
		<Copy SourceFiles="@(EnterpriseServerBuildFiles)" DestinationFolder="$(EnterpriseServerBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreatePortalBuild" DependsOnTargets="CreateEnterpriseServerBuild">
		<ItemGroup>
			<PortalBuildExclude Include="$(PortalSrc)\**\ref\**" />
			<PortalBuildExclude Include="$(PortalSrc)\**\.svn\**" />
			<PortalBuildExclude Include="$(PortalSrc)\**\obj\**" />
			<PortalBuildExclude Include="$(PortalSrc)\bin\*.xml" />
			<PortalBuildExclude Include="$(PortalSrc)\**\Release\**" />
			<PortalBuildExclude Include="$(PortalSrc)\**\Debug\**" />
			<PortalBuildExclude Include="$(PortalSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<PortalBuildExclude Include="$(PortalSrc)\**\*.user" />
			<PortalBuildExclude Include="$(PortalSrc)\**\*.suo" />
			<PortalBuildExclude Include="$(PortalSrc)\**\*.cs" />
			<PortalBuildExclude Include="$(PortalSrc)\**\*.snk" />
			<PortalBuildExclude Include="$(PortalSrc)\packages.config" />			
			<PortalBuildExclude Include="$(PortalSrc)\**\*.csproj" />
			<PortalBuildExclude Include="$(PortalSrc)\Code\**" />
			<PortalBuildExclude Include="$(PortalSrc)\DesktopModules\**\bin\**" />
			<PortalBuildExclude Include="$(PortalSrc)\DesktopModules\**\scripts\**" />
			<PortalBuildExclude Include="$(PortalSrc)\DesktopModules\**\web.config" />
			<PortalBuildFiles Include="$(PortalSrc)\**\*.*" Exclude="@(PortalBuildExclude)" />
		</ItemGroup>

		<Copy SourceFiles="@(PortalBuildFiles)" DestinationFolder="$(PortalBuild)\%(RecursiveDir)" Condition=" '$(UseAspNetPrecompile)' != 'true' " />

		<!-- Use aspnet_compiler to percompile WebPortal if UseAspNetPrecompile is set to true -->
		<MSBuild Projects="$(TrunkFolder)\Sources\FuseCP.WebPortal\FuseCP.WebPortal.csproj" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)" Targets="DeployWithPrecompile" 
			Condition=" '$(UseAspNetPrecompile)' == 'true' " />
	</Target>

	<Target Name="CreateSchedulerBuild" DependsOnTargets="CreatePortalBuild">
		<!--<ItemGroup>
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\.svn\**" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\obj\**" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\bin\*.xml" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\Release\**" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\Debug\**" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\*.user" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\*.suo" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\*.snk" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\*.cs" />
			<SchBuildExclude Include="$(SchedulerServiceSrc)\**\*.csproj" />
			<SchedulerServiceBuildFiles Include="$(SchedulerServiceSrc)\**\*.*" Exclude="@(SchBuildExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(SchedulerServiceBuildFiles)" DestinationFolder="$(SchedulerServiceBuild)\%(RecursiveDir)" />-->
	</Target>


	<Target Name="CreateWebDavPortalBuild" DependsOnTargets="CreateSchedulerBuild">
		<ItemGroup>
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\ref\**" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\.svn\**" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\obj\**" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\bin\*.config" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\bin\*.pdb" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\bin\*.xml" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\Release\**" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\Debug\**" />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
      <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.user" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.suo" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.cs" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.snk" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\packages.config" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.csproj" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\**\*.sln" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\web.release.config" />
	  <WebDavPortalBuildExclude Include="$(WebDavPortalSrc)\web.debug.config" />
	  <WebDavPortalBuildFiles Include="$(WebDavPortalSrc)\**\*.*" Exclude="@(WebDavPortalBuildExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(WebDavPortalBuildFiles)" DestinationFolder="$(WebDavPortalBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateImportCsvBuild" DependsOnTargets="CreateWebDavPortalBuild">
		<ItemGroup>
			<ImportCsvExclude Include="$(ImportCsvSrc)\**\ref\**" />
			<ImportCsvExclude Include="$(ImportCsvSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<ImportCsvExclude Include="$(ImportCsvSrc)\**\*.vshost.*" />
			<ImportCsvBuildFiles Include="$(ImportCsvSrc)\**\*.*" Exclude="@(ImportCsvExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(ImportCsvBuildFiles)" DestinationFolder="$(ImportCsvBuild)\%(RecursiveDir)" />
	</Target>

  <Target Name="CreateHyperVUtilsBuild" DependsOnTargets="CreateImportCsvBuild">
		<ItemGroup>
			<HyperVUtilsExclude Include="$(HyperVUtilsSrc)\**\ref\**" />
			<HyperVUtilsExclude Include="$(HyperVUtilsSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<HyperVUtilsExclude Include="$(HyperVUtilsSrc)\**\*.vshost.*" />
			<HyperVUtilsBuildFiles Include="$(HyperVUtilsSrc)\**\*.*" Exclude="@(HyperVUtilsExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(HyperVUtilsBuildFiles)" DestinationFolder="$(HyperVUtilsBuild)\%(RecursiveDir)" />
	</Target>

  <Target Name="CreateVMConfigBuild" DependsOnTargets="CreateHyperVUtilsBuild">
		<ItemGroup>
			<VMConfigExclude Include="$(VMConfigSrc)\**\ref\**" />
			<VMConfigExclude Include="$(VMConfigSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<VMConfigExclude Include="$(VMConfigSrc)\**\*.vshost.*" />
			<VMConfigBuildFiles Include="$(VMConfigSrc)\**\*.*" Exclude="@(VMConfigExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(VMConfigBuildFiles)" DestinationFolder="$(VMConfigBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateImportEnterpriseBuild" DependsOnTargets="CreateVMConfigBuild">
		<ItemGroup>
			<ImportEnterpriseExclude Include="$(ImportEnterpriseSrc)\**\ref\**" />
			<ImportEnterpriseExclude Include="$(ImportEnterpriseSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<ImportEnterpriseExclude Include="$(ImportEnterpriseSrc)\**\*.vshost.*" />
			<ImportEnterpriseBuildFiles Include="$(ImportEnterpriseSrc)\**\*.*" Exclude="@(ImportEnterpriseExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(ImportEnterpriseBuildFiles)" DestinationFolder="$(ImportEnterpriseBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateCertMakerBuild" DependsOnTargets="CreateImportEnterpriseBuild">
		<ItemGroup>
			<CertMakerExclude Include="$(CertMakerSrc)\**\ref\**" />
			<CertMakerExclude Include="$(CertMakerSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<CertMakerExclude Include="$(CertMakerSrc)\**\*.vshost.*" />
			<CertMakerBuildFiles Include="$(CertMakerSrc)\**\*.*" Exclude="@(CertMakerExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(CertMakerBuildFiles)" DestinationFolder="$(CertMakerBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateAWStatsViewerBuild" DependsOnTargets="CreateCertMakerBuild">
		<ItemGroup>
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\ref\**" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\.svn\**" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\obj\**" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\bin\*.xml" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\Release\**" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\Debug\**" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\*.user" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\*.suo" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\*.cs" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\*.csproj" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\Code\**" />
			<AWStatsViewerBuildExclude Include="$(AWStatsViewerSrc)\**\*.publish.xml" />
			<AWStatsViewerBuildFiles Include="$(AWStatsViewerSrc)\**\*.*" Exclude="@(AWStatsViewerBuildExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(AWStatsViewerBuildFiles)" DestinationFolder="$(AWStatsViewerBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateFCPTransportAgentBuild" DependsOnTargets="CreateAWStatsViewerBuild">
		<ItemGroup>
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\ref\**" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\.svn\**" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\obj\**" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\bin\*.xml" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.cache" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\microsoft.*" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\app.config" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.txt" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.user" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.suo" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.cs" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.csproj" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\Code\**" />
				<FCPTransportAgentBuildExclude Include="$(FCPTransportAgentSrc)\**\*.publish.xml" />
				<FCPTransportAgentBuildFiles Include="$(FCPTransportAgentSrc)\**\*.*" Exclude="@(FCPTransportAgentBuildExclude)" />
		</ItemGroup>
		<Copy SourceFiles="@(FCPTransportAgentBuildFiles)" DestinationFolder="$(FCPTransportAgentBuild)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateLocalizationToolkitBuild" DependsOnTargets="CreateFCPTransportAgentBuild">
		<Exec Command="dotnet restore /p:BuildWithNetFrameworkHostedCompiler=true $(TrunkFolder)\Sources\Tools\FuseCP.LocalizationToolkit.sln" />

		<!-- compile toolkit -->
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FuseCP.LocalizationToolkit\FuseCP.LocalizationToolkit.csproj" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform)">
			<Output
                TaskParameter="TargetOutputs"
                ItemName="LocalizationToolkitExe" />
		</MSBuild>

		<!-- generate default resources -->
		<Exec Command="@(LocalizationToolkitExe) -L $(PortalSrc)"/>

		<!-- build MSI package -->
		<MSBuild Projects="$(TrunkFolder)\Sources\Tools\FuseCP.LocalizationToolkit.Wix\FuseCP.LocalizationToolkit.Wix.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform);DefineSolutionProperties=false">
			<Output
                TaskParameter="TargetOutputs"
                ItemName="LocalizationToolkitMsi" />
		</MSBuild>
		<Copy SourceFiles="@(LocalizationToolkitMsi)" DestinationFolder="$(LocalizationToolkitBuild)\%(RecursiveDir)" />
		<Copy SourceFiles="$(TrunkFolder)\Sources\Tools\FuseCP.LocalizationToolkit\bin\$(BuildConfiguration)\Data\en-US\Resources.xml" DestinationFolder="$(RootFolder)\Languages" />
	</Target>

	<Target Name="CreateSetupBuild" DependsOnTargets="CreateLocalizationToolkitBuild">

		<PropertyGroup>
			<InstallerProjectRoot>$(RootFolder)\FuseCP.Installer\Sources\</InstallerProjectRoot>
			<InstallerProjectBin>$(InstallerProjectRoot)FuseCP.UniversalInstaller\bin\$(BuildConfiguration)\net10.0</InstallerProjectBin>
		</PropertyGroup>

		<Exec Command="dotnet restore /p:BuildWithNetFrameworkHostedCompiler=true $(InstallerProjectRoot)FuseCP.Installer.sln" />
		<!--<Exec Command="dotnet restore /p:BuildWithNetFrameworkHostedCompiler=true $(InstallerProjectRoot)FuseCP.Installer.Legacy.sln" />-->

		<!-- compile Installer -->
		<MSBuild Projects="$(InstallerProjectRoot)FuseCP.Installer.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform);VisualStudioVersion=$(VisualStudioVersion)" />
		<!--<MSBuild Projects="$(InstallerProjectRoot)FuseCP.Installer.Legacy.sln" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform);VisualStudioVersion=17.12.4" />-->

		<!-- copy installer binaries for upgrade -->
		<ItemGroup>
			<InstallerBinaries Include="$(InstallerProjectBin)\**\*.dll" Exclude="$(InstallerProjectBin)\**\Setup2.dll;$(InstallerProjectBin)\**\ref\**" />
			<InstallerBinaries Include="$(InstallerProjectBin)\**\*.exe" />
			<InstallerBinaries Include="$(InstallerProjectBin)\**\*.Installer.deps.json" />
			<InstallerBinaries Include="$(InstallerProjectBin)\**\*.runtimeconfig.json" />
			<SetupDll Include="$(InstallerProjectRoot)\FuseCP.Setup\bin\$(BuildConfiguration)\**\Setup2.dll" />
			<SetupDll Include="$(InstallerProjectRoot)\FuseCP.Setup\bin\$(BuildConfiguration)\**\Setup2.pdb" />
		</ItemGroup>
		<Copy SourceFiles="@(InstallerBinaries)" DestinationFolder="$(InstallerBuild)\%(RecursiveDir)" />
		<Copy SourceFiles="@(SetupDll)" DestinationFolder="$(SetupBuildFolder)" />

        <!-- build MSI package -->
        <Exec Command="&quot;$(DevEnv)&quot; &quot;$(InstallerProjectRoot)FuseCP.UniversalInstaller.Msi.sln&quot; /build &quot;$(BuildConfiguration)|$(Platform)&quot;" />
        <ItemGroup>
            <InstallerMsi Include="$(InstallerProjectRoot)\FuseCP.UniversalInstaller.Msi\$(BuildConfiguration)\*.msi" />
        </ItemGroup>
        <Copy SourceFiles="@(InstallerMsi)" DestinationFolder="$(BuildFolder)" />

	</Target>
	
	<Target Name="CreateInstallPackages" DependsOnTargets="ZipTools" Condition="'$(BuildLinuxInstallPackages)' == 'true'">
		<PropertyGroup>
			<InstallerProjectRoot>$(RootFolder)\FuseCP.Installer\Sources\</InstallerProjectRoot>
			<InstallerProjectBin>$(InstallerProjectRoot)FuseCP.UniversalInstaller\bin\$(BuildConfiguration)\net48\</InstallerProjectBin>
			<DeployPackagesDir>$(DeployFolder)\Packages</DeployPackagesDir>
			<PackagesBinDir>$(InstallerProjectRoot)FuseCP.InstallPackages\bin</PackagesBinDir>
		</PropertyGroup>

		<!-- build install packages -->
		<MSBuild Projects="$(InstallerProjectRoot)FuseCP.InstallPackages\InstallPackages.proj" Properties="BuildConfiguration=$(BuildConfiguration);Configuration=$(BuildConfiguration);Version=$(Version);FileVersion=$(FileVersion);VersionLabel=$(VersionLabel);ReleaseDate=$(ReleaseDate);Platform=$(Platform)" />

		<MakeDir Directories="$(DeployPackagesDir)" />

		<ItemGroup>
			<PackageFiles Include="$(PackagesBinDir)\*.*" />
		</ItemGroup>

		<Copy SourceFiles="@(PackageFiles)" DestinationFolder="$(DeployPackagesDir)" />

		<ItemGroup>
			<DebPackages Include="$(DeployPackagesDir)\*.deb" />
			<RPMPackages Include="$(DeployPackagesDir)\*.rpm" />
		</ItemGroup>

		<Copy SourceFiles="@(DebPackages)" DestinationFolder="$(InstallerProjectRoot)FuseCP.InstallPackages\www\debian\pool\main" />
		<Copy SourceFiles="@(RPMPackages)" DestinationFolder="$(InstallerProjectRoot)FuseCP.InstallPackages\www\fedora\pool\main" />

	</Target>

	<Target Name="CreateFixDefaultPublicFolderMailboxBuild" DependsOnTargets="CreateSetupBuild">
    	<ItemGroup>
    		<FixDefaultPublicFolderMailboxExclude Include="$(FixDefaultPublicFolderMailboxSrc)\**\ref\**" />
    		<FixDefaultPublicFolderMailboxExclude Include="$(FixDefaultPublicFolderMailboxSrc)\**\*.pdb" Condition=" '$(BuildConfiguration)' == 'Release' And !$(IncludeReleasePdbs) " />
    		<FixDefaultPublicFolderMailboxExclude Include="$(FixDefaultPublicFolderMailboxSrc)\**\*.vshost.*" />
    		<FixDefaultPublicFolderMailboxBuildFiles Include="$(FixDefaultPublicFolderMailboxSrc)\**\*.*" Exclude="@(FixDefaultPublicFolderMailboxExclude)" />
    	</ItemGroup>
    	<Copy SourceFiles="@(FixDefaultPublicFolderMailboxBuildFiles)" DestinationFolder="$(FixDefaultPublicFolderMailboxBuild)\%(RecursiveDir)" />
	</Target>


    <Target Name="WiXCreateRedistFileListBuild" DependsOnTargets="CreateFixDefaultPublicFolderMailboxBuild">
        <RemoveDir Directories="$(WiXInstallerBuild)\ComponentsFiles" />
        <MakeDir Directories="$(WiXInstallerBuild)\ComponentsFiles" />
        <Exec Command='"$(WIX)\bin\heat.exe" dir $(EnterpriseServerBuild) -o $(WiXInstallerBuild)\ComponentsFiles\EnterpriseServerFiles.wxs -gg -sreg -srd -var wix.BUILDESPATH -cg EnterpriseServerFiles -dr PI_ESERVER_INSTALL_DIR' />
        <Exec Command='"$(WIX)\bin\heat.exe" dir $(ServerBuild) -o $(WiXInstallerBuild)\ComponentsFiles\ServerFiles.wxs -gg -sreg -srd -var wix.BUILDSPATH -cg ServerFiles -dr PI_SERVER_INSTALL_DIR' />
        <Exec Command='"$(WIX)\bin\heat.exe" dir $(PortalBuild) -o $(WiXInstallerBuild)\ComponentsFiles\PortalFiles.wxs -gg -sreg -srd -var wix.BUILDPPATH -cg PortalFiles -dr PI_PORTAL_INSTALL_DIR' />
        <Exec Command='"$(WIX)\bin\heat.exe" dir $(WebDavPortalBuild) -o $(WiXInstallerBuild)\ComponentsFiles\WebDavPortalFiles.wxs -gg -sreg -srd -var wix.BUILDWDPPATH -cg WebDavPortalFiles -dr PI_WEBDAVPORTAL_INSTALL_DIR' />

		<MSBuild Projects="$(RootFolder)\FuseCP.Installer\Sources\Setup.WIX\Setup.Wix.wixproj" Properties="Configuration=$(BuildConfiguration);DefineSolutionProperties=false">
			<Output
                TaskParameter="TargetOutputs"
                ItemName="FuseCPInstallerMsi" />
		</MSBuild>

		<MSBuild Projects="$(RootFolder)\FuseCP.Installer\Sources\FuseCP.SchedulerServiceInstaller\FuseCP.SchedulerServiceInstaller.csproj" Properties="Configuration=$(BuildConfiguration);Platform=$(Platform);DefineSolutionProperties=false"/>

		<Copy SourceFiles="@(FuseCPInstallerMsi)" DestinationFolder="$(DeployFolder)\%(RecursiveDir)" />
	</Target>

    <Target Name="Build" DependsOnTargets="CreateFixDefaultPublicFolderMailboxBuild">
		<!-- Do nothing -->
	</Target>

	<Target Name="Test">
		<Exec Command="dotnet test $(TrunkFolder)\Sources\FuseCP.Test.sln" />
	</Target>

  <!-- Create full distributives -->
	<PropertyGroup>
		<InstallFolder>$(DeployFolder)\Install</InstallFolder>
		<ServerInstall>$(InstallFolder)\Server</ServerInstall>
		<EnterpriseServerInstall>$(InstallFolder)\EnterpriseServer</EnterpriseServerInstall>
		<SchedulerServiceInstall>$(InstallFolder)\SchedulerService</SchedulerServiceInstall>
		<PortalInstall>$(InstallFolder)\Portal</PortalInstall>
		<WebDavPortalInstall>$(InstallFolder)\WebDavPortal</WebDavPortalInstall>
		<StandaloneInstall>$(InstallFolder)\StandaloneServerSetup</StandaloneInstall>

		<!-- Tools -->
		<ToolsFolder>$(DeployFolder)\Tools</ToolsFolder>
		<ImportCsvInstall>$(ToolsFolder)\Import.CsvBulk</ImportCsvInstall>
		<HyperVUtilsInstall>$(ToolsFolder)\HyperVUtils</HyperVUtilsInstall>
		<VMConfigInstall>$(ToolsFolder)\VMconfig</VMConfigInstall>
		<ImportEnterpriseInstall>$(ToolsFolder)\Import.Enterprise</ImportEnterpriseInstall>
		<AWStatsViewerInstall>$(ToolsFolder)\AWStats.Viewer</AWStatsViewerInstall>
		<CertMakerInstall>$(ToolsFolder)\CertificateMaker</CertMakerInstall>
		<FCPTransportAgentInstall>$(ToolsFolder)\FCPTransportAgent</FCPTransportAgentInstall>
		<FuseCP-Configuration-ToolInstall>$(ToolsFolder)\FuseCP-Configuration-Tool</FuseCP-Configuration-ToolInstall>
		<MSPtoFCPInstall>$(ToolsFolder)\MSPtoFCP</MSPtoFCPInstall>
		<MailTemplatesInstall>$(ToolsFolder)\MailTemplates</MailTemplatesInstall>
		<FuseCP-Auto-Upgrade-ToolInstall>$(ToolsFolder)\FuseCP-Auto-Upgrade-Tool</FuseCP-Auto-Upgrade-ToolInstall>
		<FuseCP-dSHeuristicsInstall>$(ToolsFolder)\FuseCP-dSHeuristics</FuseCP-dSHeuristicsInstall>
    <FixDefaultPublicFolderMailboxInstall>$(ToolsFolder)\FixDefaultPublicFolderMailbox</FixDefaultPublicFolderMailboxInstall>
  </PropertyGroup>

	<Target Name="PrepareInstalls" DependsOnTargets="Build">
		<Delete Files="$(InstallFolder)\**\*.*"/>
		<RemoveDir Directories="$(InstallFolder)"/>
		<MakeDir Directories="$(InstallFolder)"/>

		<Delete Files="$(ToolsFolder)\**\*.*"/>
		<RemoveDir Directories="$(ToolsFolder)"/>
		<MakeDir Directories="$(ToolsFolder)"/>
	</Target>

	<Target Name="CreateServerInstall" DependsOnTargets="PrepareInstalls">
		<ItemGroup>
			<ServerDeployFiles Include="$(ServerBuild)\**\*.*" Exclude="@(ServerDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(ServerInstall)"/>
		<MakeDir Directories="$(ServerInstall)"/>
		<Copy SourceFiles="@(ServerDeployFiles)" DestinationFolder="$(ServerInstall)\%(RecursiveDir)" />
		<XmlUpdate XmlFileName="$(ServerInstall)\web.config" Xpath="//configuration/FuseCP.server/security/password/@value" Value="${installer.server.password}" />
	</Target>

	<Target Name="CreateEnterpriseServerInstall" DependsOnTargets="CreateServerInstall">
		<ItemGroup>
			<EnterpriseServerDeployFiles Include="$(EnterpriseServerBuild)\**\*.*" Exclude="@(EnterpriseServerDeployExclude)" />
			<!-- Scheduler is already in EnterpriseServer bin folder 
			<SchedulerServiceDeployExclude Include="$(SchedulerServiceBuild)\bin\FuseCP.SchedulerService.exe.config" />
			<SchedulerServiceDeployFiles Include="$(SchedulerServiceBuild)\**\*.*" Exclude="@(SchedulerServiceDeployExclude)" />-->
		</ItemGroup>
		<RemoveDir Directories="$(EnterpriseServerInstall)"/>
		<MakeDir Directories="$(EnterpriseServerInstall)"/>
		<Copy SourceFiles="@(EnterpriseServerDeployFiles)" DestinationFolder="$(EnterpriseServerInstall)\%(RecursiveDir)" />
		<!--<Copy SourceFiles="@(SchedulerServiceDeployFiles)" DestinationFolder="$(EnterpriseServerInstall)\%(RecursiveDir)\bin" />-->
		<XmlUpdate XmlFileName="$(EnterpriseServerInstall)\web.config" Xpath="//configuration/connectionStrings/add/@connectionString" Value="${installer.connectionstring}"  />
		<XmlUpdate XmlFileName="$(EnterpriseServerInstall)\web.config" Xpath="//configuration/appSettings/add[@key=%22FuseCP.CryptoKey%22]/@value" Value="${installer.cryptokey}"  />
	</Target>

	<Target Name="CreatePortalInstall" DependsOnTargets="CreateEnterpriseServerInstall">
		<ItemGroup>
			<PortalDeployFiles Include="$(PortalBuild)\**\*.*" Exclude="@(PortalDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(PortalInstall)"/>
		<MakeDir Directories="$(PortalInstall)"/>
		<Copy SourceFiles="@(PortalDeployFiles)" DestinationFolder="$(PortalInstall)\%(RecursiveDir)" />
		<XmlUpdate XmlFileName="$(PortalInstall)\App_Data\SiteSettings.config" Xpath="//SiteSettings/EnterpriseServer" Value="http://127.0.0.1:9002"  />
	</Target>

	<Target Name="CreateWebDavPortalInstall" DependsOnTargets="CreatePortalInstall">
		<ItemGroup>
			<WebDavPortalDeployFiles Include="$(WebDavPortalBuild)\**\*.*" Exclude="@(WebDavPortalDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(WebDavPortalInstall)"/>
		<MakeDir Directories="$(WebDavPortalInstall)"/>
		<Copy SourceFiles="@(WebDavPortalDeployFiles)" DestinationFolder="$(WebDavPortalInstall)\%(RecursiveDir)" />
	</Target>

	<Target Name="CreateImportCsvInstall" DependsOnTargets="CreateWebDavPortalInstall">
		<ItemGroup>
			<ImportCsvDeployFiles Include="$(ImportCsvBuild)\**\*.*" Exclude="@(ImportCsvDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(ImportCsvInstall)"/>
		<MakeDir Directories="$(ImportCsvInstall)"/>
		<Copy SourceFiles="@(ImportCsvDeployFiles)" DestinationFolder="$(ImportCsvInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(ImportCsvInstall)" />
	</Target>

  <Target Name="CreateHyperVUtilsCsvInstall" DependsOnTargets="CreateImportCsvInstall">
		<ItemGroup>
			<HyperVUtilsDeployFiles Include="$(HyperVUtilsBuild)\**\*.*" Exclude="@(HyperVUtilsDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(HyperVUtilsInstall)"/>
		<MakeDir Directories="$(HyperVUtilsInstall)"/>
		<Copy SourceFiles="@(HyperVUtilsDeployFiles)" DestinationFolder="$(HyperVUtilsInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(HyperVUtilsInstall)" />
	</Target>

  <Target Name="CreateVMConfigInstall" DependsOnTargets="CreateHyperVUtilsCsvInstall">
		<ItemGroup>
			<VMConfigDeployFiles Include="$(VMConfigBuild)\**\*.*" Exclude="@(VMConfigDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(VMConfigInstall)"/>
		<MakeDir Directories="$(VMConfigInstall)"/>
		<Copy SourceFiles="@(VMConfigDeployFiles)" DestinationFolder="$(VMConfigInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(VMConfigInstall)" />
	</Target>

	<Target Name="CreateImportEnterpriseInstall" DependsOnTargets="CreateVMConfigInstall">
		<ItemGroup>
			<ImportEnterpriseDeployFiles Include="$(ImportEnterpriseBuild)\**\*.*" Exclude="@(ImportEnterpriseDeployExclude)" />
		</ItemGroup>
		<RemoveDir Directories="$(ImportEnterpriseInstall)"/>
		<MakeDir Directories="$(ImportEnterpriseInstall)"/>
		<Copy SourceFiles="@(ImportEnterpriseDeployFiles)" DestinationFolder="$(ImportEnterpriseInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(ImportEnterpriseInstall)" />
	</Target>

	<Target Name="CreateCertMakerInstall" DependsOnTargets="CreateImportEnterpriseInstall">
		<ItemGroup>
			<CertMakerDeployFiles Include="$(CertMakerBuild)\**\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(CertMakerInstall)"/>
		<MakeDir Directories="$(CertMakerInstall)"/>
		<Copy SourceFiles="@(CertMakerDeployFiles)" DestinationFolder="$(CertMakerInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(CertMakerInstall)" />
	</Target>
	
	<Target Name="CreateFCPTransportAgentInstall" DependsOnTargets="CreateCertMakerInstall">
		<ItemGroup>
			<FCPTransportAgentDeployFiles Include="$(FCPTransportAgentBuild)\**\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(FCPTransportAgentInstall)"/>
		<MakeDir Directories="$(FCPTransportAgentInstall)"/>
		<Copy SourceFiles="@(FCPTransportAgentDeployFiles)" DestinationFolder="$(FCPTransportAgentInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(FCPTransportAgentInstall)" />
	</Target>

	<Target Name="CreateAWStatsViewerInstall" DependsOnTargets="CreateFCPTransportAgentInstall">
		<ItemGroup>
			<AWStatsViewerDeployFiles Include="$(AWStatsViewerBuild)\**\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(AWStatsViewerInstall)"/>
		<MakeDir Directories="$(AWStatsViewerInstall)"/>
		<Copy SourceFiles="@(AWStatsViewerDeployFiles)" DestinationFolder="$(AWStatsViewerInstall)\%(RecursiveDir)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(AWStatsViewerInstall)" />
	</Target>

	<Target Name="CreateLocalizationToolkitInstall" DependsOnTargets="CreateAWStatsViewerInstall">
		<ItemGroup>
			<LocalizationToolkitDeployFiles Include="$(LocalizationToolkitBuild)\**\*.*" />
		</ItemGroup>
		<Copy SourceFiles="@(LocalizationToolkitDeployFiles)" DestinationFolder="$(ToolsFolder)\%(RecursiveDir)" />
	</Target>

  <Target Name="CreateFixDefaultPublicFolderMailboxInstall" DependsOnTargets="CreateLocalizationToolkitInstall">
    <ItemGroup>
      <FixDefaultPublicFolderMailboxDeployFiles Include="$(FixDefaultPublicFolderMailboxBuild)\**\*.*" />
    </ItemGroup>
    <RemoveDir Directories="$(FixDefaultPublicFolderMailboxInstall)"/>
    <MakeDir Directories="$(FixDefaultPublicFolderMailboxInstall)"/>
    <Copy SourceFiles="@(FixDefaultPublicFolderMailboxDeployFiles)" DestinationFolder="$(FixDefaultPublicFolderMailboxInstall)\%(RecursiveDir)" />
    <Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(FixDefaultPublicFolderMailboxInstall)" />
  </Target>

  	<Target Name="CreateFuseCP-Configuration-ToolInstall" DependsOnTargets="CreateFixDefaultPublicFolderMailboxInstall">
		<ItemGroup>
			<FuseCP-Configuration-ToolFiles Include="$(FuseCP-Configuration-ToolSrc)\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(FuseCP-Configuration-ToolInstall)"/>
		<MakeDir Directories="$(FuseCP-Configuration-ToolInstall)"/>
		<Copy SourceFiles="@(FuseCP-Configuration-ToolFiles)" DestinationFolder="$(FuseCP-Configuration-ToolInstall)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(FuseCP-Configuration-ToolInstall)" />
	</Target>
	
  	<Target Name="MSPtoFCPInstall" DependsOnTargets="CreateFuseCP-Configuration-ToolInstall">
		<ItemGroup>
			<MSPtoFCPFiles Include="$(MSPtoFCPSrc)\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(MSPtoFCPInstall)"/>
		<MakeDir Directories="$(MSPtoFCPInstall)"/>
		<Copy SourceFiles="@(MSPtoFCPFiles)" DestinationFolder="$(MSPtoFCPInstall)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(MSPtoFCPInstall)" />
	</Target>
	
	<Target Name="MailTemplatesInstall" DependsOnTargets="MSPtoFCPInstall">
	<ItemGroup>
		<MailTemplatesFiles Include="$(MailTemplatesSrc)\**\*.*" />
	</ItemGroup>
	<RemoveDir Directories="$(MailTemplatesInstall)"/>
	<MakeDir Directories="$(MailTemplatesInstall)"/>
	<Copy SourceFiles="@(MailTemplatesFiles)" DestinationFolder="$(MailTemplatesInstall)\%(RecursiveDir)" />
	<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(MailTemplatesInstall)" />
	</Target>
	
  	<Target Name="FuseCP-Auto-Upgrade-ToolInstall" DependsOnTargets="MailTemplatesInstall">
		<ItemGroup>
			<FuseCP-Auto-Upgrade-ToolFiles Include="$(FuseCP-Auto-Upgrade-ToolSrc)\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(FuseCP-Auto-Upgrade-ToolInstall)"/>
		<MakeDir Directories="$(FuseCP-Auto-Upgrade-ToolInstall)"/>
		<Copy SourceFiles="@(FuseCP-Auto-Upgrade-ToolFiles)" DestinationFolder="$(FuseCP-Auto-Upgrade-ToolInstall)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(FuseCP-Auto-Upgrade-ToolInstall)" />
	</Target>
	
  	<Target Name="FuseCP-dSHeuristics" DependsOnTargets="FuseCP-Auto-Upgrade-ToolInstall">
		<ItemGroup>
			<FuseCP-dSHeuristicsFiles Include="$(FuseCP-dSHeuristicsSrc)\*.*" />
		</ItemGroup>
		<RemoveDir Directories="$(FuseCP-dSHeuristicsInstall)"/>
		<MakeDir Directories="$(FuseCP-dSHeuristicsInstall)"/>
		<Copy SourceFiles="@(FuseCP-dSHeuristicsFiles)" DestinationFolder="$(FuseCP-dSHeuristicsInstall)" />
		<Copy SourceFiles="$(RootFolder)\LICENSE" DestinationFolder="$(FuseCP-dSHeuristicsInstall)" />
	</Target>


  <!-- Create update from previous version -->
	<PropertyGroup>
		<UpdateFolder>$(DeployFolder)\Update</UpdateFolder>
		<ServerUpdate>$(UpdateFolder)\Server</ServerUpdate>
		<EnterpriseServerUpdate>$(UpdateFolder)\EnterpriseServer</EnterpriseServerUpdate>
		<PortalUpdate>$(UpdateFolder)\Portal</PortalUpdate>
		<WebDavPortalUpdate>$(UpdateFolder)\WebDavPortal</WebDavPortalUpdate>
	</PropertyGroup>

	<Target Name="PrepareUpdates" DependsOnTargets="FuseCP-dSHeuristics">
		<RemoveDir Directories="$(UpdateFolder)"/>
		<MakeDir Directories="$(UpdateFolder)"/>

		<RemoveDir Directories="$(ServerUpdate)"/>
		<MakeDir Directories="$(ServerUpdate)"/>

		<RemoveDir Directories="$(EnterpriseServerUpdate)"/>
		<MakeDir Directories="$(EnterpriseServerUpdate)"/>

		<RemoveDir Directories="$(PortalUpdate)"/>
		<MakeDir Directories="$(PortalUpdate)"/>
		
		<RemoveDir Directories="$(WebDavPortalUpdate)"/>
		<MakeDir Directories="$(WebDavPortalUpdate)"/>
	</Target>

	<Target Name="CreateServerUpdate" DependsOnTargets="PrepareUpdates">
		<Exec Command="$(DiffCmd) %22$(PreviousBuildFolder)\Server%22 %22$(ServerInstall)%22  %22$(ServerUpdate)%22 /ex:web.config"/>
	</Target>

	<Target Name="CreateEnterpriseServerUpdate" DependsOnTargets="CreateServerUpdate" >
		<Exec Command="$(DiffCmd) %22$(PreviousBuildFolder)\EnterpriseServer%22 %22$(EnterpriseServerInstall)%22 %22$(EnterpriseServerUpdate)%22 /ex:web.config"/>
		
		<ItemGroup>
			<InstallScripts Include="$(EnterpriseServerDataSrc)\Migrations\**\install.*.sql" />
			<InstallScripts Include="$(EnterpriseServerDataSrc)\Migrations\**\install.*.bundle.exe" />
			<UpdateScript Include="$(EnterpriseServerDataSrc)\LegacyScripts\update_db.sql" />
		</ItemGroup>

		<Copy SourceFiles="@(InstallScripts)" DestinationFolder="$(EnterpriseServerUpdate)\Setup" />
		<Copy SourceFiles="@(UpdateScript)" DestinationFolder="$(EnterpriseServerUpdate)\Setup" />

		<!-- Update variables in the file -->
		<FileUpdate Files="$(EnterpriseServerUpdate)\Setup\update_db.sql" Regex="\${release.version}" ReplacementText="$(FileVersion)" />
		<FileUpdate Files="$(EnterpriseServerUpdate)\Setup\update_db.sql" Regex="\${release.date}" ReplacementText="$(ReleaseDate)" />

		<Copy SourceFiles="@(UpdateScript)" DestinationFolder="$(UpdateFolder)" />
		<Copy SourceFiles="@(InstallScripts)" DestinationFolder="$(UpdateFolder)" />
		<!-- Update variables in the file -->
		<FileUpdate Files="$(UpdateFolder)\update_db.sql" Regex="\${release.version}" ReplacementText="$(FileVersion)" />
		<FileUpdate Files="$(UpdateFolder)\update_db.sql" Regex="\${release.date}" ReplacementText="$(ReleaseDate)" />
	</Target>

	<Target Name="CreatePortalUpdate" DependsOnTargets="CreateEnterpriseServerUpdate" >
		<Exec Command="$(DiffCmd) %22$(PreviousBuildFolder)\Portal%22 %22$(PortalInstall)%22  %22$(PortalUpdate)%22 /ex:web.config,web6.config" />
	</Target>
	
	<Target Name="CreateWebDavPortalUpdate" DependsOnTargets="CreatePortalUpdate" >
		<Exec Command="$(DiffCmd) %22$(PreviousBuildFolder)\WebDavPortal%22 %22$(WebDavPortalInstall)%22  %22$(WebDavPortalUpdate)%22 /ex:web.config,Web.Debug.config,Web.Release.config,FuseCP.WebDavPortal.sln"/>
	</Target>

	<!-- Create Enterprise Server database and script it -->
	<PropertyGroup>
		<DatabaseFolder>$(DeployFolder)\Database</DatabaseFolder>
	</PropertyGroup>

    <Target Name="CreateEnterpriseServerDatabase" DependsOnTargets="CreateWebDavPortalUpdate" Condition="'$(BuildLegacyDatabaseScript)' == 'true'">
		<MakeDir Directories="$(DatabaseFolder)"/>

		<Exec Command="$(SqlCmd) -Q &quot;IF DB_ID (N'$(DataBaseName)') IS NOT NULL DROP DATABASE $(DataBaseName)&quot;" />
		<Exec Command="$(SqlCmd) -Q &quot;CREATE DATABASE $(DataBaseName) COLLATE Latin1_General_CI_AS&quot;" />

		<Copy SourceFiles="$(EnterpriseServerDataSrc)\LegacyScripts\install_db.sql" DestinationFolder="$(DatabaseFolder)" />
		<Copy SourceFiles="$(EnterpriseServerDataSrc)\LegacyScripts\update_db.sql" DestinationFolder="$(DatabaseFolder)" />

		<!-- Update variables in files -->
		<FileUpdate Files="$(DatabaseFolder)\install_db.sql" Regex="\${install.database}" ReplacementText="$(DataBaseName)" />
		<FileUpdate Files="$(DatabaseFolder)\update_db.sql" Regex="\${install.database}" ReplacementText="$(DataBaseName)" />
		<FileUpdate Files="$(DatabaseFolder)\update_db.sql" Regex="\${release.version}" ReplacementText="$(FileVersion)" />
		<FileUpdate Files="$(DatabaseFolder)\update_db.sql" Regex="\${release.date}" ReplacementText="$(ReleaseDate)" />

		<Exec Command="$(SqlCmd) -i $(DatabaseFolder)\install_db.sql" />
		<Exec Command="$(SqlCmd) -i $(DatabaseFolder)\update_db.sql" />

		<Delete Files="$(DatabaseFolder)\install_db.sql" />
		<Delete Files="$(DatabaseFolder)\update_db.sql" />
	</Target>

	<Target Name="ScriptEnterpriseServerDatabase" DependsOnTargets="CreateEnterpriseServerDatabase" Condition="'$(BuildLegacyDatabaseScript)' == 'true'">
		<ConvertToAbsolutePath Paths="$(DatabaseFolder)">
			<Output TaskParameter="AbsolutePaths" PropertyName="DatabaseFolderAbsolute"/>
		</ConvertToAbsolutePath>

		<Exec Command="$(MSDeployPath) -verb:sync -source:dbFullSql=&quot;$(MSDeployConnectionString)&quot; -dest:dbFullSql=&quot;$(DatabaseFolderAbsolute)\install_db_temp.sql&quot;"/>
		<Exec Command="copy $(TrunkFolder)\Resources\database_header.sql+$(DatabaseFolder)\install_db_temp.sql $(DatabaseFolder)\install_db.sql" />

		<MakeDir Directories="$(EnterpriseServerInstall)\Setup"/>

		<Copy SourceFiles="$(DatabaseFolder)\install_db.sql" DestinationFolder="$(EnterpriseServerInstall)\Setup" />

		<Delete Files="$(DatabaseFolder)\install_db_temp.sql" />
	</Target>

	<Target Name="PublishSqlInstallScripts" DependsOnTargets="ScriptEnterpriseServerDatabase;CreateWebDavPortalUpdate">
		<MakeDir Directories="$(DatabaseFolder)" />
		<MakeDir Directories="$(EnterpriseServerInstall)\Setup"/>

		<ItemGroup>
			<InstallScripts Include="$(EnterpriseServerDataSrc)\Migrations\**\install.*.sql" />
			<InstallScripts Include="$(EnterpriseServerDataSrc)\Migrations\**\install.*.bundle.exe" />
		</ItemGroup>
		<!--<Copy SourceFiles="$(TrunkFolder)\Database\install_db.sql" DestinationFolder="$(DatabaseFolder)" />-->
		<Copy SourceFiles="@(InstallScripts)" DestinationFolder="$(TrunkFolder)\Database" />
		<Copy SourceFiles="@(InstallScripts)" DestinationFolder="$(DatabaseFolder)" />
		<Copy SourceFiles="$(EnterpriseServerDataSrc)\LegacyScripts\update_db.sql" DestinationFolder="$(DatabaseFolder)" />
		<Copy SourceFiles="@(InstallScrips)" DestinationFolder="$(EnterpriseServerInstall)\Setup" />
	</Target>

	<!-- Compile and deploy Setup.dll -->
	<Target Name="CopySetupDLL" DependsOnTargets="PublishSqlInstallScripts">
        <!-- Restore -->
        <!--<Exec Command="dotnet restore $(InstallerProjectRoot)\FuseCP.Installer.sln" />-->
        <!-- Compile Setup.dll -->
        <!--<MSBuild Projects="$(SetupTrunkFolder)\Sources\FuseCP.Installer.sln"  Properties="Configuration=$(BuildConfiguration);Platform=$(Platform);VisualStudioVersion=$(VisualStudioVersion)" />-->

		<!-- Copy Setup.dll -->
		<MakeDir Directories="$(ServerInstall)\Setup" />
		<MakeDir Directories="$(ServerUpdate)\Setup" />
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(ServerInstall)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(ServerInstall)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(ServerUpdate)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(ServerUpdate)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->

		<MakeDir Directories="$(EnterpriseServerInstall)\Setup" />
		<MakeDir Directories="$(EnterpriseServerUpdate)\Setup" />
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(EnterpriseServerInstall)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(EnterpriseServerInstall)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(EnterpriseServerUpdate)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(EnterpriseServerUpdate)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->

		<MakeDir Directories="$(PortalInstall)\Setup"/>
		<MakeDir Directories="$(PortalUpdate)\Setup"/>
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(PortalInstall)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(PortalInstall)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(PortalUpdate)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(PortalUpdate)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->

		<MakeDir Directories="$(WebDavPortalInstall)\Setup"/>
		<MakeDir Directories="$(WebDavPortalUpdate)\Setup"/>
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(WebDavPortalInstall)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(WebDavPortalInstall)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(WebDavPortalUpdate)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(WebDavPortalUpdate)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->

		<RemoveDir Directories="$(StandaloneInstall)"/>
		<MakeDir Directories="$(StandaloneInstall)"/>
		<MakeDir Directories="$(StandaloneInstall)\Setup"/>
		<Copy SourceFiles="$(SetupBuildFolder)\Setup2.dll" DestinationFolder="$(StandaloneInstall)\Setup" />
		<!--<Copy SourceFiles="$(SetupBuildFolder)\Setup2.pdb" DestinationFolder="$(StandaloneInstall)\Setup" Condition=" '$(BuildConfiguration)' == 'Debug' Or $(IncludeReleasePdbs) " />-->
    </Target>

	<Target Name="DeploySqlScripts" DependsOnTargets="CopySetupDLL">
		<ItemGroup>
			<SqlInstallScripts Include="$(DatabaseFolder)\*.sql" />
			<SqlInstallScripts Include="$(DatabaseFolder)\*.bundle.exe" />
		</ItemGroup>
		<Copy SourceFiles="@(SqlInstallScripts)" DestinationFolder="$(EnterpriseServerInstall)\Setup" />
	</Target>

    <UsingTask TaskName="RegExpReplace" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
        <ParameterGroup>
          <Path ParameterType="System.String" Required="true" />
          <Pattern ParameterType="System.String" Required="true" />
          <Replacement ParameterType="System.String" Required="true" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System.Text.RegularExpressions"/>
            <Code Type="Fragment" Language="cs">
                <![CDATA[
                    var Text = File.ReadAllText(Path);
                    var RegExp = new Regex(Pattern);
                    Text = RegExp.Replace(Text, Replacement);
                    File.WriteAllText(Path, Text);
                ]]>
            </Code>
        </Task>
  </UsingTask>

  <Target Name='Demo' >
    <TokenReplace Path="C:\Project\Target.config" Token="$MyToken$" Replacement="MyValue"/>
  </Target>

	<!-- Deploy -->
	<Target Name="ZipSetupDll" DependsOnTargets="DeploySqlScripts" >
		<ItemGroup>
			<PortalInstallFiles Include="$(PortalInstall)\**\*.*" />
			<WebDavPortalInstallFiles Include="$(WebDavPortalInstall)\**\*.*" />
			<EnterpriseServerInstallFiles Include="$(EnterpriseServerInstall)\**\*.*" />
			<ServerInstallFiles Include="$(ServerInstall)\**\*.*" />

			<!--
			<ImportCsvInstallFiles Include="$(ImportCsvInstall)\**\*.*" />
			<HyperVUtilsInstallFiles Include="$(HyperVUtilsInstall)\**\*.*" />
			<VMConfigInstallFiles Include="$(VMConfigInstall)\**\*.*" />
			<ImportEnterpriseInstallFiles Include="$(ImportEnterpriseInstall)\**\*.*" />
			<AWStatsViewerInstallFiles Include="$(AWStatsViewerInstall)\**\*.*" />
			<FCPTransportAgentInstallFiles Include="$(FCPTransportAgentInstall)\**\*.*" />
			-->
		</ItemGroup>

		<!-- Assemble "Standalone" package -->
		<Copy SourceFiles="@(PortalInstallFiles)" DestinationFolder="$(StandaloneInstall)\Portal\%(RecursiveDir)" />
		<Copy SourceFiles="@(WebDavPortalInstallFiles)" DestinationFolder="$(StandaloneInstall)\WebDavPortal\%(RecursiveDir)" />
		<Copy SourceFiles="@(EnterpriseServerInstallFiles)" DestinationFolder="$(StandaloneInstall)\Enterprise Server\%(RecursiveDir)" />
		<Copy SourceFiles="@(ServerInstallFiles)" DestinationFolder="$(StandaloneInstall)\Server\%(RecursiveDir)" />


		<!-- zip full distributives
		<ItemGroup>
			<StandaloneInstallFiles Include="$(StandaloneInstall)\**\*.*" />
		</ItemGroup>
		-->
		<ItemGroup>
			<ZipFilesToDelete Include="$(DeployFolder)\*.zip" />
			<ZipFilesToDelete Include="$(ToolsFolder)\*.zip" />
			<ZipFilesToDelete Include="$(DeployFolder)\*.7z" />
			<ZipFilesToDelete Include="$(ToolsFolder)\*.7z" />
		</ItemGroup>
		
		<Delete Files="@(ZipFilesToDelete)" />
        
        <!-- Zip Setup2.dll to DeployFolder -->
		<Message Text="Zip Setup2.dll" Importance="high" />
        <Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\Setup2.dll$(ZipExt)&quot; &quot;$(SetupBuildFolder)\Setup2.dll&quot;" />
	</Target>
    
	<Target Name="ZipPortal" DependsOnTargets="ZipSetupDll">
		<!--
		<Zip Files="@(PortalInstallFiles)" ZipFileName="$(DeployFolder)\FuseCP-Portal-$(Version).zip" WorkingDirectory="$(PortalInstall)" />
		<Zip Files="@(WebDavPortalInstallFiles)" ZipFileName="$(DeployFolder)\FuseCP-Web-Dav-Portal-$(Version).zip" WorkingDirectory="$(WebDavPortalInstall)" />
		<Zip Files="@(EnterpriseServerInstallFiles)" ZipFileName="$(DeployFolder)\FuseCP-EnterpriseServer-$(Version).zip" WorkingDirectory="$(EnterpriseServerInstall)" />
		<Zip Files="@(ServerInstallFiles)" ZipFileName="$(DeployFolder)\FuseCP-Server-$(Version).zip" WorkingDirectory="$(ServerInstall)" />
		<Zip Files="@(StandaloneInstallFiles)" ZipFileName="$(DeployFolder)\FuseCP-StandaloneServerSetup-$(Version).zip" WorkingDirectory="$(StandaloneInstall)" />
		-->
		<Message Text="Zip Portal" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Portal$(ZipExt)&quot; &quot;$(PortalInstall)\*&quot;" />
	</Target>
	<Target Name="ZipWebDavPortal" DependsOnTargets="ZipPortal">
		<Message Text="Zip WebDavPortal" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Web-Dav-Portal$(ZipExt)&quot; &quot;$(WebDavPortalInstall)\*&quot;" />
	</Target>
	<Target Name="ZipEnterpriseServer" DependsOnTargets="ZipWebDavPortal">
		<Message Text="Zip EnterpriseServer" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-EnterpriseServer$(ZipExt)&quot; &quot;$(EnterpriseServerInstall)\*&quot;" />
	</Target>
	<Target Name="ZipServer" DependsOnTargets="ZipEnterpriseServer">
		<Message Text="Zip Server" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Server$(ZipExt)&quot; &quot;$(ServerInstall)\*&quot;" />
	</Target>
	<Target Name="ZipStandalone" DependsOnTargets="ZipServer">
		<Message Text="Zip StandaloneServerSetup" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-StandaloneServerSetup$(ZipExt)&quot; &quot;$(StandaloneInstall)\*&quot;" />

		<ItemGroup>
			<InstallerMsiFile Include="$(BuildFolder)\*.msi" />
		</ItemGroup>
		
		<Copy SourceFiles="@(InstallerMsiFile)" DestinationFiles="$(DeployFolder)\FuseCP.Installer-$(Version).msi" />
	</Target>

	<Target Name="ZipUpdates" DependsOnTargets="ZipStandalone">
		<!-- zip updates
		<ItemGroup>
			<PortalUpdateFiles Include="$(PortalUpdate)\**\*.*" />
			<EnterpriseServerUpdateFiles Include="$(EnterpriseServerUpdate)\**\*.*" />
			<ServerUpdateFiles Include="$(ServerUpdate)\**\*.*" />
			<ManualUpdateFiles Include="$(UpdateFolder)\**\*.*" />
			<InstallerUpdateFiles Include="$(InstallerBuild)\**\*.*" />
		</ItemGroup>


		<Zip Files="@(PortalUpdateFiles)" ZipFileName="$(DeployFolder)\FuseCP-Portal-$(Version)-Update.zip" WorkingDirectory="$(PortalUpdate)" />
		<Zip Files="@(EnterpriseServerUpdateFiles)" ZipFileName="$(DeployFolder)\FuseCP-EnterpriseServer-$(Version)-Update.zip" WorkingDirectory="$(EnterpriseServerUpdate)" />
		<Zip Files="@(ServerUpdateFiles)" ZipFileName="$(DeployFolder)\FuseCP-Server-$(Version)-Update.zip" WorkingDirectory="$(ServerUpdate)" />
		<Zip Files="@(ManualUpdateFiles)" ZipFileName="$(DeployFolder)\Manual-Update.zip" WorkingDirectory="$(UpdateFolder)" />
		<Zip Files="@(InstallerUpdateFiles)" ZipFileName="$(DeployFolder)\FuseCP-Installer-$(Version)-Update.zip" WorkingDirectory="$(InstallerBuild)" />
		-->
		<Message Text="Zip Updates" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Portal-Update$(ZipExt)&quot; &quot;$(PortalUpdate)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-WebDavPortal-Update$(ZipExt)&quot; &quot;$(WebDavPortalUpdate)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-EnterpriseServer-Update$(ZipExt)&quot; &quot;$(EnterpriseServerUpdate)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Server-Update$(ZipExt)&quot; &quot;$(ServerUpdate)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Manual-Update$(ZipExt)&quot; &quot;$(UpdateFolder)\*&quot;" />
	</Target>

	<Target Name="ZipInstaller" DependsOnTargets="ZipUpdates">
		<Message Text="Zip Installer" Importance="high" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(DeployFolder)\FuseCP-Installer.zip&quot; &quot;$(InstallerBuild)\*&quot;" />

		<!-- zip tools
		<Zip Files="@(ImportCsvInstallFiles)" ZipFileName="$(ToolsFolder)\FuseCP-Import-CsvBulk-$(Version).zip" WorkingDirectory="$(ImportCsvInstall)" />
		<Zip Files="@(HyperVUtilsInstallFiles)" ZipFileName="$(ToolsFolder)\FuseCP-HyperVUtils-$(Version).zip" WorkingDirectory="$(HyperVUtilsInstall)" />
		<Zip Files="@(VMConfigInstallFiles)" ZipFileName="$(ToolsFolder)\FuseCP-VMConfig-$(Version).zip" WorkingDirectory="$(VMConfigInstall)" />
		<Zip Files="@(ImportEnterpriseInstallFiles)" ZipFileName="$(ToolsFolder)\FuseCP-Import-Enterprise-$(Version).zip" WorkingDirectory="$(ImportEnterpriseInstall)" />
		<Zip Files="@(AWStatsViewerInstallFiles)" ZipFileName="$(ToolsFolder)\FuseCP-AWStatsViewer-$(Version).zip" WorkingDirectory="$(AWStatsViewerInstall)" />
		<Zip Files="@(FCPTransportAgentInstallFiles)" ZipFileName="$(ToolsFolder)\FuseCP-FCPTransportAgent-$(Version).zip" WorkingDirectory="$(FCPTransportAgentInstall)" />
		-->
	</Target>

	<Target Name="ZipTools" DependsOnTargets="ZipInstaller">
		<Message Text="Zip Tools" Importance="high" />
        <Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-Import-CsvBulk$(ZipExt)&quot; &quot;$(ImportCsvInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-HyperVUtils$(ZipExt)&quot; &quot;$(HyperVUtilsInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-VMConfig$(ZipExt)&quot; &quot;$(VMConfigInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-Import-Enterprise$(ZipExt)&quot; &quot;$(ImportEnterpriseInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-AWStatsViewer$(ZipExt)&quot; &quot;$(AWStatsViewerInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-FCPTransportAgent$(ZipExt)&quot; &quot;$(FCPTransportAgentInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-FixDefaultPublicFolderMailbox$(ZipExt)&quot; &quot;$(FixDefaultPublicFolderMailboxInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-Configuration-Tool$(ZipExt)&quot; &quot;$(FuseCP-Configuration-ToolInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-CertificateMaker$(ZipExt)&quot; &quot;$(CertMakerInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\MSPtoFCP$(ZipExt)&quot; &quot;$(MSPtoFCPInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\MailTemplates$(ZipExt)&quot; &quot;$(MailTemplatesInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-Auto-Upgrade-Tool$(ZipExt)&quot; &quot;$(FuseCP-Auto-Upgrade-ToolInstall)\*&quot;" />
		<Exec Command="$(ZipCmd)$(ZipLevel) a &quot;$(ToolsFolder)\FuseCP-dSHeuristics$(ZipExt)&quot; &quot;$(FuseCP-dSHeuristicsInstall)\*&quot;" />
  </Target>

  <Target Name="Deploy" DependsOnTargets="CreateInstallPackages" />
	
  <Target Name="uploadwebpi" DependsOnTargets="BuildWebPlatformInstallerFeed">
		  <FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCPFeed-$(Version).xml" LocalFile="$(DeployFolder)\FuseCPFeed.xml" />
  </Target>

  <!-- This task depends on FTP upload task and will be run afterwards -->
  <Target Name="BuildWebPlatformInstallerFeed" DependsOnTargets="uploadtoftp">
    <ItemGroup>
      <!-- This will generate path to a temporary file that will be used by WebDownload task below to download the installer's distributive locally -->
      <InstallerFilePath Include="$([System.IO.Path]::GetTempFileName())" />
    </ItemGroup>
    <PropertyGroup>
      <GetFileSizeScript>
        <![CDATA[
          public static string ScriptMain() {
            System.Int32 KB = 1024;
            System.IO.FileInfo fileInfo = new System.IO.FileInfo(@"%(InstallerFilePath.FullPath)");
            return System.Convert.ToString(fileInfo.Length / KB);
          }
        ]]>
      </GetFileSizeScript>
      <ComputeChecksumScript>
        <![CDATA[
          public static string ScriptMain() {
            System.String checksumStr = "";
            using(System.IO.FileStream stream = System.IO.File.OpenRead(@"%(InstallerFilePath.FullPath)"))
            {
                System.Security.Cryptography.SHA1Managed sha = new System.Security.Cryptography.SHA1Managed();
                System.Byte[] checksum = sha.ComputeHash(stream);
                checksumStr = System.BitConverter.ToString(checksum).Replace("-", System.String.Empty);
            }
            return checksumStr;
          }
        ]]>
      </ComputeChecksumScript>
    </PropertyGroup>
    <WebDownload FileUri="$(InstallerRemoteUri)" FileName="%(InstallerFilePath.FullPath)" />
    <Script Language="C#" Code="$(ComputeChecksumScript)">
      <Output TaskParameter="ReturnValue" PropertyName="InstallerFileChecksum" />
    </Script>
    <Script Language="C#" Code="$(GetFileSizeScript)">
      <Output TaskParameter="ReturnValue" PropertyName="InstallerFileSize" />
    </Script>
    <Delete Files="%(InstallerFilePath.FullPath)" />
    <ItemGroup>
      <Tokens Include="ProductVersion">
        <ReplacementValue>$(Version)</ReplacementValue>
      </Tokens>
      <Tokens Include="ProductTitle">
        <ReplacementValue>FuseCP $(Version)</ReplacementValue>
      </Tokens>
      <Tokens Include="ReleaseDate">
        <ReplacementValue>$(ReleaseDate)T00:00:00Z</ReplacementValue>
      </Tokens>
      <Tokens Include="InstallerFileSize">
        <ReplacementValue>$(InstallerFileSize)</ReplacementValue>
      </Tokens>
      <Tokens Include="InstallerFileSHA1">
        <ReplacementValue>$(InstallerFileChecksum)</ReplacementValue>
      </Tokens>
      <Tokens Include="InstallerFileUrl">
        <ReplacementValue>$(InstallerRemoteUri)</ReplacementValue>
      </Tokens>
    </ItemGroup>
    <TemplateFile Template="$(TrunkFolder)\FuseCPFeedTemplate.xml" OutputFilename="$(DeployFolder)\FuseCPFeed.xml" Tokens="@(Tokens)" />
  </Target>

  <Target Name="upload-sp-update">
    <FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/Manual-Update-sp$(ZipExt)" LocalFile="$(DeployFolder)\Manual-Update$(ZipExt)" />
  </Target>

  <Target Name="uploadtoftp">
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Portal$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-Portal$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Web-Dav-Portal$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-Web-Dav-Portal$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-EnterpriseServer$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-EnterpriseServer$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Server$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-Server$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-StandaloneServerSetup$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-StandaloneServerSetup$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Portal-Update$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-Portal-Update$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-EnterpriseServer-Update$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-EnterpriseServer-Update$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Server-Update$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-Server-Update$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Installer-Update$(ZipExt)" LocalFile="$(DeployFolder)\FuseCP-Installer-Update$(ZipExt)" />
    <FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Installer-Unix-$(Version).zip" LocalFile="$(DeployFolder)\FuseCP-Installer-Unix-$(Version).zip" />
    <FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Import-CsvBulk$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-Import-CsvBulk$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-Import-Enterprise$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-Import-Enterprise$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-CertificateMaker$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-CertificateMaker$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-AWStatsViewer$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-AWStatsViewer$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-FCPTransportAgent$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-FCPTransportAgent$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP.LocalizationToolkit.msi" LocalFile="$(ToolsFolder)\FuseCP.LocalizationToolkit.msi" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP.Installer-$(Version).msi" LocalFile="$(DeployFolder)\FuseCP.Installer-$(Version).msi" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCPInstaller.exe" LocalFile="$(DeployFolder)\FuseCP.Installer.exe" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-HyperVUtils$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-HyperVUtils$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-VMConfig$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-VMConfig$(ZipExt)" />
	<FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/Manual-Update$(ZipExt)" LocalFile="$(DeployFolder)\Manual-Update$(ZipExt)" />
    <FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/FuseCP-FixDefaultPublicFolderMailbox$(ZipExt)" LocalFile="$(ToolsFolder)\FuseCP-FixDefaultPublicFolderMailbox$(ZipExt)" />
    <FtpUpload Username="$(ftpUsername)" password="$(ftpPassword)" RemoteUri="ftp://$(ftphost)/Setup2.dll$(ZipExt)" LocalFile="$(DeployFolder)\Setup2.dll$(ZipExt)" />
  </Target>

  <Import Project="$(RootFolder)\tools\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>

</Project>
